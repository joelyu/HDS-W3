---
title: "Immune Cell Infiltration Across Breast Cancer Subtypes: A Marker Gene Analysis of the METABRIC Cohort"
author: "cyy36@cam.ac.uk"
date: today
bibliography: references.bib
csl: nature.csl
link-citations: true
execute:
  warning: false
  message: false
  echo: false
  cache: true
format:
  html:
    toc: true
    toc-location: left
    toc-depth: 2
    embed-resources: true
    theme:
      dark: darkly
      light: flatly
---

# Cover Page {.unnumbered .unlisted}

<center>
![](https://onlinecareeraccelerators.pace.cam.ac.uk/hubfs/CAM%20DS%20PACE/Professional%20and%20Continuing%20Education_V_reversed%20colour%201.svg)
</center>

### MSt Healthcare Data Science {.unnumbered .unlisted}

#### Authentication of practice

|   |   |
|---|---|
|I confirm that I have fully read and understood the assignment brief for this module.| **Y** |

#### Details

|   |   |
|---|---|
|Name: Chung Yan|Surname: Yu|
|Submission Date|  |
|Word Count: whole assignment including codes|  |
|Word Count: main body excluding abstract, references and supplementary materials|  |

#### Permission to share your assignment

I do give permission to share my assignment with future MSt participants.

#### University statement of originality

This assignment is the result of my own work and includes nothing which is the outcome of work done in collaboration except as declared in the Preface and specified in the text. It is not substantially the same as any that I have previously submitted for a degree or diploma or other qualification at the University of Cambridge or any other university or similar institution, or that is being concurrently submitted, except as declared in the Preface and specific in the text. I further state that no substantial part of my Portfolio has already been submitted, nor is being concurrently submitted for any such degree, diploma or other qualification at the University of Cambridge or any other university or similar institution except as declared in the Preface and specified in the text.

|   |   |
|---|---|
|I confirm the statement of originality as above| **Y** |


#### Questions for reflection

Self-assessment is an important aspect of feedback literacy, which is, in turn, key to the development of expertise. As you proceed through the MSt Healthcare data science programme, we hope that you will make use of the following prompts to assess your own work on assignments. Specific assignment briefs will likely indicate which of these to address for which assessments, but, in general, we expect you to respond to one or two for each assignment on your course.

For each of the questions, do not spend too long answering – keep it brief. For each question you answer, limit yourself to no more than three items. And please remember, this is optional and developmental: these cover sheets are designed to create space for self-assessment and feedback dialogue, rather than additional assignment workload.

1. Which aspects of this assignment are you most uncertain about and/or would most like to receive feedback on?


2. What elements are you left pondering after this assignment that you would like to discuss further?


3. How have you incorporated feedback from peers and tutors into this assignment?


4. How, and to what extent, have you been able to incorporate feedback on previous course work into this assignment?


5. Using the wording in the rubric, how would you describe the quality of the different aspects of your work?


### Declaration of the use of generative AI {.unnumbered .unlisted}

|   |   |
|---|---|
|Which permitted use of generative AI are you acknowledging?| Semantic search of literature and notes, outline creation, output formatting, informed feedback, code generation |
|Which generative AI tool did you use (name and version)?| Claude Code v2.1.1x (Opus 4.6), M365 CoPilot |
|What did you use the tool for?| Searching for relevant journal publications (via PubMed MCP), collating notes in my Obsidian vault, `.bib` file curation, code debugging+generation |
|How have you used or changed the generative AI's output| My collated notes always stay in point form so that I write out the paragraphs in my own words. Feedback provided by the GenAI models are weighed and assessed before being acted on. |



# Abstract

The ability for immune cells to infiltrate the tumour microenvironment (TME) plays a key role in the biological war machine taking on breast cancer.

# Introduction

Tumour cells evading the detection and wrath of the immune system is a recognised hallmark of cancer[@hanahan2011hallmarks], and breast cancer is no exception[@gildelalcazar2020immune]. The interplay between tumour cells, immune cells and other local factors form the tumour microenvironment (TME), and research in the TME of breast cancers has yielded clinical applications[@li2021TME]. The amount of tumour infiltrating immune cells in breast cancers has shown prognostic value[@salgado2015evaluation], and this amount and prognostic impact varies across breast cancer's molecular subtypes[@stanton2016clinical]. These subtypes are defined by gene expression[@perou2000molecular], and are popularised and commercialised as the PAM50 gene expression panel, which has its own prognostic significance[@parker2009supervised]. The subtypes include luminal A, luminal B, HER2-enriched, basal-like and normal-like.

The METABRIC cohort from Curtis et al.[@curtis2012genomic] is one of the larger datasets on breast cancer containing clinical, gene expression and mutation data of 2,509 patients. METABRIC's analysis has already shown immune infiltration in one of their integrative clusters (IntClust4), showing deletions in T cell receptors and mRNA amplification for immune cell activity, but stopped short of fully characterising the immune cells involved. Jiang et al.[@jiang2020tumour] characterised immune cell infiltration in the METABRIC cohort using CIBERSORT[@newman2015CIBERSORT], developing new immunotypes with prognostic significance. However, CIBERSORT is more of a black box model, a computational approach using deconvolution to estimate cell proportions from RNA mixtures. Therefore there exists a need to use a transparent approach to score immune cell infiltration in METABRIC's breast tumour samples, and scrutinise any prognostic value from such scoring.

A panel of immune cell marker genes developed by Danaher et al.[@danaher2017gene] were used to score immune infiltration in the METABRIC cohort. The infiltration of different immune cell types as well as their prognostic value were investigated across the PAM50 subtypes. The goal is to characterise the immune landscape across PAM50 subtypes, identify which immune populations associate with survival, and test whether immune cell scores or multi-dimensional immune profiles improve prognostic value beyond subtype classification alone. 

# Methods

```{r setup, output=FALSE}
#| label: setup
#| code-summary: "Setup: Installing and verifying packages, setting up filepaths"

# --- Package installation and loading ---
# Most of the packages are handled via conda/mamba
# This is to verify the packages and install them if missing
# Certain packages are hard to retrieve when on arm64 macs, these are loaded below
# File and folder paths for downstream processing are also defined here
options(repos = c(CRAN = "https://cloud.r-project.org"))

if (!require(tidyverse, quietly = TRUE))    install.packages("tidyverse")
if (!require(survival, quietly = TRUE))     install.packages("survival")
if (!require(survminer, quietly = TRUE))    install.packages("survminer")
if (!require(gtsummary, quietly = TRUE))    install.packages("gtsummary")
if (!require(UpSetR, quietly = TRUE))       install.packages("UpSetR")
if (!require(forestplot, quietly = TRUE))   install.packages("forestplot")
if (!require(pheatmap, quietly = TRUE))     install.packages("pheatmap")
if (!require(ggpubr, quietly = TRUE))       install.packages("ggpubr")
if (!require(patchwork, quietly = TRUE))    install.packages("patchwork")
if (!require(RColorBrewer, quietly = TRUE))  install.packages("RColorBrewer")
if (!require(multcompView, quietly = TRUE)) install.packages("multcompView")
if (!require(ggrepel, quietly = TRUE))      install.packages("ggrepel")
if (!require(cluster, quietly = TRUE))      install.packages("cluster")
if (!require(kableExtra, quietly = TRUE))   install.packages("kableExtra")
if (!require(circlize, quietly = TRUE))     install.packages("circlize")

if (!require(BiocManager, quietly = TRUE))  install.packages("BiocManager")
if (!require(ComplexHeatmap, quietly = TRUE)) BiocManager::install("ComplexHeatmap")
if (!require(cBioPortalData, quietly = TRUE)) BiocManager::install("cBioPortalData")

library(tidyverse)
library(survival)
library(survminer)
library(gtsummary)
library(UpSetR)
library(forestplot)
library(pheatmap)
library(ComplexHeatmap)
ht_opt$message <- FALSE
library(ggpubr)
library(patchwork)
library(RColorBrewer)

# --- P-value formatter: 3 decimals, or <0.001 ---
fmt_p <- function(p) ifelse(p < 0.001, "<0.001", sprintf("%.3f", p))

# --- Data paths (relative to repo root) ---
proc_dir  <- "data/processed"
clin_file <- file.path(proc_dir, "clinical.csv")
mut_file  <- file.path(proc_dir, "mutations.maf")
expr_file <- file.path(proc_dir, "expression_immune_markers.csv")
```
```{r}
#| label: import-scoring-exploration
#| output: false
#| echo: true
#| code-fold: true
#| code-summary: "Click here to see how to pull fresh data straight from cBioPortal."
# To pull fresh data from cBioPortal instead of using the included processed files,
# delete the data/processed/ folder and re-render this document.
source("scripts/00-data-cleaning.R")
source("scripts/01-immune-cell-scoring.R")
source("scripts/02-task1-exploration.R")
```

This study makes use of the METABRIC dataset[@curtis2012genomic] available on cBioPortal[@cerami2012cbioportal; @gao2013integrative; @debruijn2023analysis], including clinical, gene expression and mutation datasets of 2,509 patients. For gene expression, the log2 intensity was used in place of the normalised z-score to preserve the proportions when applying the immune cell scoring. 

The principle of avoiding circularity guided two data selection decisions. First, PAM50 subtypes were chosen over IntClust as IntClust subtypes are defined by copy number aberrations that can directly influence immune marker gene expression, and IntClust4 is already characterised by immune infiltration. The clear lack of overlap between the PAM50 and Danaher's immune cell gene panels also strengthened this choice. Second, the exclusion of Claudin-low patients. Claudin-low is another breast cancer subtype used alongside PAM50 subtypes on cBioPortal's METABRIC dataset, and is characterised by immune infiltration[@fougner2020claudinReDef]. Fougner et al.[@fougner2020claudinReDef] further demonstrated that Claudin-low is not an independent subtype in addition to the PAM50 subtypes, therefore patients of this category (n = `r sum(clinical$pam50_subtype == "claudin-low", na.rm = TRUE)`) were removed.

Immune cell scoring is done by taking the mean log2 gene expression of the cell types' marker genes, originally defined by Danaher et al.[@danaher2017gene] and tabulated in [Table S1](#panel-tbl-s1). Of the 60 marker genes from the Danaher panel, only 58 genes have expression data in the METABRIC dataset. TPSB2 is missing for mast cells and XCL2 for NK cells. The CD4 T cell score is derived by subtracting the CD8 T cell score from the overall T cell score. The Danaher scoring method was chosen for its simplicity and marker genes validated against flow cytometry, in contrast to deconvolution approaches previously applied to this cohort[@jiang2020tumour].

Immune variation across PAM50 subtypes was assessed by Kruskal-Wallis test with Wilcoxon for pairwise comparisons. Prognostic associations were evaluated using Cox proportional hazards models, first univariately and then multivariately to adjust for PAM50 subtypes, along with Kaplan-Meier curves with log-rank tests for visualisation. To develop multi-dimensional immune profiles, clusters were fitted via k-means with silhouette scoring. All p-values from multiple testing were corrected via Benjamini-Hochberg false discovery rate (FDR) and reported as FDR throughout. Overall survival was used for prognosis as the disease-specific survival data used by Curtis et al.[@curtis2012genomic] was not available on cBioPortal.

::: {#panel-tbl-s1}
```{r methods-coverage}
#| label: methods-coverage
#| code-summary: "Show gene coverage for immune cell scoring"
coverage_df %>%
  group_by(Cell_type) %>%
  summarise(
    Markers = n(),
    Found = sum(In_METABRIC),
    `Genes used` = paste(Gene[In_METABRIC], collapse = ", "),
    `Genes missing` = paste(Gene[!In_METABRIC], collapse = ", "),
    .groups = "drop"
  ) %>%
  mutate(`Genes missing` = ifelse(`Genes missing` == "", "\u2014", `Genes missing`)) %>%
  dplyr::rename(`Cell type` = Cell_type) %>%
  knitr::kable(format = "html") %>%
  kableExtra::column_spec(1, width = "8em") %>%
  kableExtra::column_spec(4, width = "24em")
```

::: {.callout-note appearance="minimal"}
### Table S1 — Immune marker gene coverage
Verifying the immune marker gene coverage on the Illumina HT-12 v3 microarray of METABRIC dataset.
:::
:::


# Results

## Cohort Summary and Mutation Landscape

::: {#panel-cohort-table}
```{r task1-table1}
#| label: task1-table1
tbl1
```

::: {.callout-note appearance="minimal"}
### Table 1 — Cohort characteristics by PAM50 subtype
Baseline characteristics of 1,756 METABRIC patients with expression data, stratified by PAM50 subtype. 218 claudin-low and 6 NC patients excluded. Continuous variables summarised as median (Q1, Q3); categorical as n (%). P-values from Kruskal-Wallis (continuous) or Pearson's Chi-squared (categorical) tests.
:::
:::

::: {#panel-upset}
```{r task1-upset, fig.width=10, fig.height=6}
#| label: task1-upset
#| code-summary: "Show patient intersection across datasets"
upset(
  membership[, -1],
  sets = c("Clinical", "Expression", "Mutations", "PAM50"),
  order.by = "freq",
  mainbar.y.label = "Patients",
  sets.x.label = "Patients per modality",
  main.bar.color = "#8DA0CB",
  sets.bar.color = "#8DA0CB",
  text.scale = c(1.5, 1.3, 1.2, 1.2, 1.5, 1.2),
  mb.ratio = c(0.6, 0.4)
)
```

::: {.callout-note appearance="minimal"}
### Figure 1 — Data availability across modalities
Intersection plot showing patient counts for each combination of available data modalities (N = 2,509).
:::
:::

```{r task1-missing-age}
#| label: task1-missing-age
#| code-summary: "Compare age between patients with and without expression data"
expr_ages <- clinical$age_at_diagnosis[clinical$has_expression]
no_expr_ages <- clinical$age_at_diagnosis[!clinical$has_expression]
n_no_expr <- sum(!clinical$has_expression)
n_expr <- sum(clinical$has_expression)
age_wilcox <- wilcox.test(no_expr_ages, expr_ages)
```

- `r n_no_expr` patients without expression data
- significantly younger than the `r n_expr` with expression data; Wilcoxon rank-sum p `r if(age_wilcox$p.value < 0.001) "< 0.001" else paste("=", sprintf("%.3f", age_wilcox$p.value))`
- median age `r round(median(no_expr_ages, na.rm = TRUE), 1)` vs `r round(median(expr_ages, na.rm = TRUE), 1)` years

The `r n_no_expr` patients without expression data were significantly younger than the `r n_expr` with expression data (median age `r round(median(no_expr_ages, na.rm = TRUE), 1)` vs `r round(median(expr_ages, na.rm = TRUE), 1)` years; Wilcoxon rank-sum p `r if(age_wilcox$p.value < 0.001) "< 0.001" else paste("=", sprintf("%.3f", age_wilcox$p.value))`).

```{r task1-mutations-compute, output=FALSE}
#| label: task1-mutations-compute
source("scripts/04-mutation-exploration.R")
```

::: {#panel-dotplot}
```{r task1-dotplot, fig.width=9, fig.height=9}
#| label: task1-dotplot
if (length(sig_genes) > 0) {
  dot_data <- wilcox_results %>%
    filter(gene %in% sig_genes) %>%
    mutate(
      cell_type = gsub("_", " ", cell_type),
      neg_log_fdr = -log10(pmax(fdr, 1e-300)),
      significant = fdr < 0.05,
      sig_category = case_when(
        fdr < 0.05 & !is.na(adj_fdr) & adj_fdr < 0.05 ~ "Significant after PAM50 adjustment",
        fdr < 0.05 ~ "Significant only before PAM50 adjustment",
        TRUE ~ "NS"
      ),
      sig_category = factor(sig_category,
        levels = c("Significant after PAM50 adjustment", "Significant only before PAM50 adjustment", "NS"))
    )

  # Order genes by number of significant associations (most at top)
  gene_summary <- dot_data %>%
    group_by(gene) %>%
    summarise(n_sig = sum(significant), n_mut = n_mut[1], .groups = "drop") %>%
    arrange(desc(n_sig))
  dot_data$gene <- factor(dot_data$gene, levels = rev(gene_summary$gene))

  # Gene labels for y-axis: include patient count and sig count
  gene_labels <- setNames(
    paste0(gene_summary$gene, "\n(n=", gene_summary$n_mut, ", ",
           gene_summary$n_sig, " sig)"),
    gene_summary$gene
  )

  max_abs_effect <- max(abs(dot_data$effect), na.rm = TRUE)

  # Count significant genes per cell type for x-axis labels
  sig_per_ct <- dot_data %>%
    group_by(cell_type) %>%
    summarise(n_sig = sum(significant), .groups = "drop")
  ct_labels <- setNames(
    paste0(sig_per_ct$cell_type, "\n(", sig_per_ct$n_sig, ")"),
    sig_per_ct$cell_type
  )

  ggplot(dot_data, aes(x = cell_type, y = gene)) +
    geom_point(aes(size = neg_log_fdr, fill = effect, colour = sig_category),
               shape = 21, stroke = 0.9) +
    scale_size_continuous(range = c(3, 10),
                          name = expression(-log[10](FDR))) +
    scale_fill_gradient2(low = "#3288BD", mid = "#FFFFBF", high = "#D53E4F",
                         midpoint = 0,
                         limits = c(-max_abs_effect, max_abs_effect),
                         name = "Effect\n(\u0394 median)") +
    scale_colour_manual(
      values = c("Significant after PAM50 adjustment" = "black",
                 "Significant only before PAM50 adjustment" = "#E78AC3",
                 "NS" = "grey75"),
      name = "Subtype confounding") +
    scale_x_discrete(labels = ct_labels) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 30, hjust = 1, size = 9),
      axis.text.y = element_text(angle = 30, hjust = 1, size = 9),
      panel.grid.major = element_line(colour = "grey92"),
      legend.position = "bottom",
      legend.box = "horizontal",
      legend.direction = "horizontal",
      legend.box.margin = margin(t = 5),
      legend.spacing.x = unit(0.5, "cm")
    ) +
    guides(
      fill = guide_colorbar(title.position = "top", barwidth = 6, barheight = 0.5, order = 1),
      size = guide_legend(title.position = "top", nrow = 1, order = 2),
      colour = guide_legend(title.position = "top", nrow = 2, order = 3, override.aes = list(size = 5))
    ) +
    scale_y_discrete(labels = gene_labels) +
    labs(x = NULL, y = NULL)
}
```

::: {.callout-note appearance="minimal"}
### Figure 2 — Mutation-immune cell score associations
Median immune cell score differences (mutated minus wild-type) for genes with at least one significant association across 14 cell types. Significance by Wilcoxon rank-sum test (FDR < 0.05); only genes mutated in ≥10 patients tested.
:::
:::

::: {#panel-volcano}
```{r task1-tp53-volcano, fig.width=8, fig.height=6}
#| label: task1-tp53-volcano
# TP53 volcano: PAM50-adjusted effect sizes and FDR
tp53_adj <- wilcox_results %>%
  filter(gene == "TP53" & !is.na(adj_effect)) %>%
  mutate(
    cell_type = gsub("_", " ", cell_type),
    neg_log_fdr = -log10(pmax(adj_fdr, 1e-300)),
    significant = adj_fdr < 0.05
  )

n_tp53_sig <- sum(tp53_adj$significant)
n_tp53_total <- nrow(tp53_adj)

ggplot(tp53_adj, aes(x = adj_effect, y = neg_log_fdr)) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed",
             colour = "grey50", linewidth = 0.5) +
  geom_vline(xintercept = 0, linetype = "dotted", colour = "grey70") +
  geom_point(aes(colour = significant), size = 4) +
  ggrepel::geom_text_repel(
    aes(label = cell_type), size = 3.2,
    max.overlaps = 20, segment.colour = "grey70"
  ) +
  scale_colour_manual(
    values = c("TRUE" = "#E41A1C", "FALSE" = "grey60"),
    labels = c("TRUE" = "FDR < 0.05", "FALSE" = "NS"), name = NULL
  ) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(
    x = "PAM50-adjusted effect (TP53 mutated vs wild-type)",
    y = expression(-log[10](FDR)),
    title = sprintf("TP53 mutation: %d/%d cell types significant after PAM50 adjustment",
                    n_tp53_sig, n_tp53_total)
  )
```

::: {.callout-note appearance="minimal"}
### Figure 3 — TP53 mutation and immune infiltration after PAM50 adjustment
PAM50-adjusted effect sizes from linear regression (x-axis) and significance (y-axis) for each immune cell type. Dashed line marks FDR = 0.05.
:::
:::


## Immune Infiltration Across PAM50 Subtypes

```{r q1-compute, output=FALSE}
#| label: q1-compute
source("scripts/03-q1-pam50-immune.R")
```

::: {#panel-heatmap}
```{r q1-heatmap, fig.width=9, fig.height=10}
#| label: q1-heatmap
ha <- HeatmapAnnotation(
  PAM50 = pam50_vals,
  col = list(PAM50 = pam50_colours),
  show_legend = TRUE,
  annotation_legend_param = list(PAM50 = list(direction = "horizontal", nrow = 1))
)
draw(Heatmap(
  heatmap_z, name = "Z-score",
  col = circlize::colorRamp2(c(-2, 0, 2), c("#3288BD", "#FFFFBF", "#D53E4F")),
  top_annotation = ha,
  cluster_rows = TRUE, cluster_columns = TRUE,
  show_column_names = FALSE,
  row_names_gp = gpar(fontsize = 10),
  column_split = pam50_vals,
  column_title_gp = gpar(fontsize = 10),
  use_raster = TRUE,
  heatmap_legend_param = list(direction = "horizontal")
), heatmap_legend_side = "bottom", annotation_legend_side = "bottom",
   merge_legend = TRUE)
```

::: {.callout-note appearance="minimal"}
### Figure 4 — Immune cell score heatmap across PAM50 subtypes
Z-scored immune cell scores for 1,756 patients, split and hierarchically clustered by PAM50 subtype. Blue = below-mean; red = above-mean infiltration.
:::
:::

::: {#panel-violin}
```{r q1-violin, fig.width=9, fig.height=18}
#| label: q1-violin

# Filter to KW-significant cell types only
sig_cell_types <- kw_results %>% filter(kw_fdr < 0.05) %>% pull(cell_type)
scores_violin <- scores_long %>% filter(cell_type %in% sig_cell_types)

# Order panels: CD45 and Cytotoxic first (umbrella markers), then alphabetical
priority_types <- c("CD45", "Cytotoxic cells")
other_types <- sort(setdiff(sig_cell_types, priority_types))
ct_order <- c(intersect(priority_types, sig_cell_types), other_types)
scores_violin$cell_type <- factor(scores_violin$cell_type, levels = ct_order)

# CLD letter positions (above global max per facet)
score_ranges <- scores_violin %>%
  group_by(cell_type) %>%
  summarise(y_min = min(score, na.rm = TRUE),
            y_max = max(score, na.rm = TRUE), .groups = "drop")

cld_plot <- cld_df %>%
  filter(cell_type %in% sig_cell_types) %>%
  left_join(score_ranges, by = "cell_type") %>%
  mutate(label_y = y_max + 0.05 * (y_max - y_min),
         cell_type = factor(cell_type, levels = ct_order))

ggplot(scores_violin, aes(x = pam50_subtype, y = score, fill = pam50_subtype)) +
  geom_violin(alpha = 0.7, scale = "width") +
  geom_boxplot(width = 0.15, outlier.size = 0.5, fill = "white", alpha = 0.8) +
  geom_text(
    data = cld_plot,
    aes(x = pam50_subtype, y = label_y, label = cld_letter),
    inherit.aes = FALSE,
    size = 3.5, fontface = "bold"
  ) +
  facet_wrap(~ cell_type, scales = "free_y", ncol = 2) +
  scale_fill_manual(values = pam50_colours) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    legend.position = "none",
    strip.text = element_text(face = "bold")
  ) +
  labs(x = NULL, y = "Immune score (mean log2 expression)")
```

::: {.callout-note appearance="minimal"}
### Figure 5 — Immune cell scores by PAM50 subtype
Violin plots with box plots for cell types reaching Kruskal-Wallis FDR < 0.05. Lettering above each subtype plot indicate similarity/difference, subtypes sharing a letter do not differ significantly (pairwise Wilcoxon, FDR < 0.05).
:::
:::


## Immune Scores and Overall Survival

```{r q2-compute, output=FALSE}
#| label: q2-compute
source("scripts/05-q2-survival.R")
```

::: {#panel-q2-forest}
```{r q2-forest, fig.width=10, fig.height=6}
#| label: q2-forest
cox_ordered <- cox_results %>% arrange(hr)
ggplot(cox_ordered, aes(x = hr, y = reorder(gsub("_", " ", cell_type), hr))) +
  geom_point(aes(colour = fdr < 0.05), size = 3) +
  geom_errorbarh(aes(xmin = hr_lower, xmax = hr_upper), height = 0.2) +
  geom_vline(xintercept = 1, linetype = "dashed", colour = "grey50") +
  scale_colour_manual(
    values = c("TRUE" = "#E41A1C", "FALSE" = "grey60"),
    labels = c("TRUE" = "FDR < 0.05", "FALSE" = "NS"), name = NULL
  ) +
  theme_minimal() +
  labs(x = "Hazard Ratio (per SD, 95% CI)", y = NULL) +
  theme(axis.text.y = element_text(size = 10), legend.position = "bottom")
```

```{r q2-cox-table}
#| label: q2-cox-table
cox_results %>%
  arrange(fdr) %>%
  mutate(
    cell_type = gsub("_", " ", cell_type),
    across(c(hr, hr_lower, hr_upper, concordance), ~ round(.x, 3)),
    across(c(p_value, fdr), fmt_p)
  ) %>%
  select(-n, -events) %>%
  knitr::kable(col.names = c("Cell type", "HR", "Lower 95% CI", "Upper 95% CI", "p-value", "C-index", "FDR"), row.names = FALSE)
```

::: {.callout-note appearance="minimal"}
### Figure 6 / Table 2 — Univariate Cox regression: immune scores and overall survival
Hazard ratios per SD increase from univariate Cox proportional hazards models for each immune cell type (FDR < 0.05).
:::
:::

Despite reaching FDR significance, the best-performing single cell type (`r gsub("_", " ", sig_cells$cell_type[1])`) achieved a concordance of only `r round(sig_cells$concordance[1], 3)`, indicating modest discriminative ability. Given the strong subtype dependence of immune infiltration observed in Q1, we next asked whether adjusting for PAM50 subtype alters the prognostic landscape.


## PAM50-Adjusted Immune Prognostic Analysis

```{r q3-within-compute, output=FALSE}
#| label: q3-within-compute
source("scripts/06-q3-within-subtype.R")
```

```{r q3-intro-text, results='asis'}
#| label: q3-intro-text
cat(sprintf(
  "To account for subtype confounding, we fitted multivariable Cox models adjusting for PAM50 subtype for each of the 14 cell types. %d cell types reached FDR < 0.05 after adjustment (%s). For these, we additionally examined per-subtype effects.",
  nrow(adj_sig_cells),
  paste(gsub("_", " ", adj_sig_cells$cell_type), collapse = ", ")
))
```

::: {#panel-q3-forest}
```{r q3-within-forest, fig.width=11, fig.height=9}
#| label: q3-within-forest
# Build combined forest: overall adjusted rows + per-subtype rows for sig cell types
overall_rows <- adj_sig_cells %>%
  select(cell_type, hr, hr_lower, hr_upper, p_value) %>%
  mutate(subtype = "Overall (PAM50-adjusted)", row_type = "overall")

subtype_rows <- per_subtype_cox %>%
  mutate(row_type = "subtype")

forest_combined <- bind_rows(overall_rows, subtype_rows) %>%
  mutate(
    label = gsub("_", " ", cell_type),
    subtype_f = factor(subtype, levels = c(
      "Overall (PAM50-adjusted)", "Basal-like", "HER2-Enriched",
      "Luminal A", "Luminal B", "Normal-like"
    )),
    # Overall row: bold cell type name; subtype row: indented subtype name
    row_label = ifelse(row_type == "overall", label,
                       paste0("    ", as.character(subtype))),
    row_uid = paste(label, row_label),
    sig = ifelse(p_value < 0.05, "sig", "ns")
  )

# Order: group by cell type (adjusted p order), overall first then subtypes
ct_order <- adj_sig_cells$cell_type
forest_combined <- forest_combined %>%
  arrange(match(cell_type, ct_order), subtype_f) %>%
  mutate(row_uid = factor(row_uid, levels = rev(unique(row_uid))))

# Display labels: strip the cell-type prefix used for uniqueness
display_labels <- setNames(forest_combined$row_label, forest_combined$row_uid)

# Grey band behind each overall (cell type header) row
overall_band <- forest_combined %>%
  filter(row_type == "overall") %>%
  mutate(y_num = as.numeric(row_uid))

ggplot(forest_combined, aes(x = hr, y = row_uid)) +
  # Highlight band behind each overall row
  geom_rect(data = overall_band,
            aes(ymin = y_num - 0.45, ymax = y_num + 0.45),
            xmin = -Inf, xmax = Inf, fill = "grey90",
            inherit.aes = FALSE) +
  geom_vline(xintercept = 1, linetype = "dashed", colour = "grey50") +
  geom_errorbarh(aes(xmin = hr_lower, xmax = hr_upper, colour = sig,
                     linewidth = row_type), height = 0.2) +
  geom_point(aes(colour = sig, shape = row_type, size = row_type)) +
  scale_linewidth_manual(values = c("overall" = 0.9, "subtype" = 0.4), guide = "none") +
  scale_colour_manual(
    values = c("sig" = "#E41A1C", "ns" = "grey60"),
    labels = c("sig" = "p < 0.05", "ns" = "NS"),
    name = NULL,
    guide = guide_legend(override.aes = list(size = 4, shape = 16))
  ) +
  scale_shape_manual(
    values = c("overall" = 18, "subtype" = 16),
    labels = c("overall" = "Overall (PAM50-adjusted)", "subtype" = "Per-subtype"),
    name = NULL,
    guide = guide_legend(override.aes = list(size = 4))
  ) +
  scale_size_manual(values = c("overall" = 5, "subtype" = 2.5), guide = "none") +
  scale_y_discrete(labels = display_labels) +
  labs(x = "Hazard Ratio per SD (95% CI)", y = NULL) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.major.y = element_blank(),
    plot.margin = margin(5, 15, 5, 5),
    legend.position = "bottom",
    legend.text = element_text(size = 11)
  )
```

```{r q3-comparison-table}
#| label: q3-comparison-table
adjusted_cox %>%
  mutate(
    cell_type = gsub("_", " ", cell_type),
    across(c(hr, hr_lower, hr_upper, concordance), ~ round(.x, 3)),
    across(c(p_value, fdr), fmt_p)
  ) %>%
  select(cell_type, hr, hr_lower, hr_upper, p_value, fdr, concordance) %>%
  knitr::kable(col.names = c("Cell type", "HR", "Lower 95% CI", "Upper 95% CI",
    "p-value", "FDR", "C-index"), row.names = FALSE)
```

::: {.callout-note appearance="minimal"}
### Figure 7 / Table 3 — PAM50-adjusted Cox regression and per-subtype effects
Cox proportional hazards models adjusted for PAM50 subtype. Forest plot shows the 4 cell types reaching FDR < 0.05; table shows all 14.
:::
:::

```{r q3-interaction-text, results='asis'}
#| label: q3-interaction-text
int_text <- interaction_tests %>%
  mutate(label = gsub("_", " ", cell_type),
         sig = ifelse(interaction_fdr < 0.05, "significant", "non-significant")) %>%
  mutate(txt = sprintf("%s (p = %s, FDR = %s)", label, fmt_p(interaction_p), fmt_p(interaction_fdr)))

sig_int <- int_text %>% filter(sig == "significant")
ns_int  <- int_text %>% filter(sig == "non-significant")

parts <- c()
if (nrow(sig_int) > 0) {
  parts <- c(parts, sprintf("significant heterogeneity across subtypes for %s",
                             paste(sig_int$txt, collapse = " and ")))
}
if (nrow(ns_int) > 0) {
  parts <- c(parts, sprintf("no significant heterogeneity for %s",
                             paste(ns_int$txt, collapse = ", ")))
}

cat(sprintf(
  "Interaction models (immune score × PAM50 subtype) revealed %s, suggesting that while the magnitude of the prognostic effect varies by subtype, the direction is broadly consistent.",
  paste(parts, collapse = ", but ")
))
```

::: {#panel-q3-km}
```{r q3-km-curves, fig.width=12, fig.height=14}
#| label: q3-km-curves
# Whole-cohort KM curves for the Q3 FDR-significant cell types
# These correspond to the overall PAM50-adjusted Cox results
km_plots <- lapply(adj_sig_cells$cell_type, function(ct) {
  plot_data <- surv_data
  plot_data$group <- factor(
    ifelse(plot_data[[ct]] >= median(plot_data[[ct]], na.rm = TRUE), "High", "Low"),
    levels = c("Low", "High")
  )
  fit <- survfit(Surv(os_months, os_event) ~ group, data = plot_data)
  adj_row <- adj_sig_cells %>% filter(cell_type == ct)
  ggsurvplot(
    fit, data = plot_data,
    pval = TRUE, pval.method = TRUE,
    risk.table = TRUE, risk.table.height = 0.3,
    palette = c("#377EB8", "#E41A1C"),
    xlab = "Time (months)", ylab = "Overall survival",
    legend.labs = c("Low", "High"),
    title = sprintf("%s (adj. HR = %.2f, FDR = %s)",
                    gsub("_", " ", ct), adj_row$hr, fmt_p(adj_row$fdr)),
    ggtheme = theme_minimal()
  )
})
arrange_ggsurvplots(km_plots, ncol = 2, nrow = 2)
```

::: {.callout-note appearance="minimal"}
### Figure 8 — Kaplan-Meier survival curves for PAM50-adjusted significant cell types
Patients split at median score. P-values from log-rank test; titles show PAM50-adjusted HR and FDR.
:::
:::


## Aggregating Immune Scores via Clustering

```{r ext-compute, output=FALSE}
#| label: ext-compute
source("scripts/07-extension.R")
```

::: {#panel-ext-heatmaps}
```{r ext-heatmaps, fig.width=9, fig.height=8}
#| label: ext-heatmaps
# All-14 cluster centroids
centroid_all14 <- as.data.frame(cluster_centroids) %>%
  rownames_to_column("cluster") %>%
  pivot_longer(-cluster, names_to = "cell_type", values_to = "z_score") %>%
  mutate(cell_type = gsub("_", " ", cell_type), panel = "All 14 cell types")

# Sig-4 cluster centroids
sig_centroids <- sig_km_final$centers
sig_cl_means_plot <- rowMeans(sig_centroids)
sig_cl_rank_plot  <- rank(-sig_cl_means_plot)
rownames(sig_centroids) <- paste0("Sig Cluster ", sig_cl_rank_plot, " (n=",
  table(sig_km_final$cluster)[as.character(seq_len(sig_optimal_k))], ")")

centroid_sig4 <- as.data.frame(sig_centroids) %>%
  rownames_to_column("cluster") %>%
  pivot_longer(-cluster, names_to = "cell_type", values_to = "z_score") %>%
  mutate(cell_type = gsub("_", " ", cell_type), panel = "4 significant cell types")

centroid_both <- bind_rows(centroid_all14, centroid_sig4) %>%
  mutate(panel = factor(panel, levels = c("All 14 cell types", "4 significant cell types")))

ggplot(centroid_both, aes(y = cell_type, x = cluster, fill = z_score)) +
  geom_tile(colour = "white", linewidth = 0.5) +
  geom_text(aes(label = round(z_score, 1)), size = 2.8) +
  scale_fill_gradient2(low = "#3288BD", mid = "#FFFFBF", high = "#D53E4F",
                       midpoint = 0, name = "Mean z-score",
                       limits = max(abs(centroid_both$z_score)) * c(-1, 1)) +
  facet_wrap(~ panel, scales = "free") +
  theme_minimal(base_size = 11) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1),
        strip.text = element_text(face = "bold")) +
  labs(x = NULL, y = NULL)
```

::: {.callout-note appearance="minimal"}
### Figure 9 — Immune cluster centroids
Mean z-scored immune cell type profiles for k-means clusters. **Left**: `r optimal_k` clusters from all 14 cell types. **Right**: `r sig_optimal_k` clusters from the 4 PAM50-adjusted significant cell types only. Clusters labelled by overall immune level. Red = above-average infiltration; blue = below-average.
:::
:::

::: {#panel-ext-comparison}
```{r ext-comparison}
#| label: ext-comparison
comparison_df %>%
  mutate(
    concordance = round(concordance, 3),
    AIC = round(AIC, 1),
    delta_AIC = round(delta_AIC, 1),
    lr_p = ifelse(is.na(lr_p), "—", fmt_p(lr_p))
  ) %>%
  knitr::kable(col.names = c("Model", "df", "Concordance", "AIC", "LR p vs PAM50", "ΔAIC"), row.names = FALSE)
```

::: {.callout-note appearance="minimal"}
### Table 4 — Prognostic comparison: PAM50 baseline vs immune-augmented models
LR test p-values against PAM50-only baseline. ΔAIC relative to baseline (negative = better fit).
:::
:::


# Discussion

<!-- TODO -->

# Conclusion

<!-- TODO -->

# References

::: {#refs}
:::

# Addendum

Even if my day job is somewhat cancer adjacent, diving deep into this METABRIC dataset made me feel like a novice when it came to cancer / breast cancer. But it has been fun seeing what we learn in class come together in more ways than one. The lead authors for the immune cell scoring paper are from the company NanoString Technologies, the same company that has the commercial PAM50 test kit that we learned in class. And in the same paper, they cite the false discovery rate (FDR) correction paper from Benjamini and Hochberg!

This whole assignment has been a rollercoaster ride, and there were so many rabbit holes that this topic would lead you into. For example Danaher didn't make it easy for me when they tweaked the TIL acronym, usually meaning tumour infiltrating lymphocytes, to sneak in leukocytes in the palce of lymphocytes, so that the immune cells of myeloid origin could be included in the paper. The inclusion of Claudin-low